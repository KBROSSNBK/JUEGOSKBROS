<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>Beyblade Neon Online (Lobby + Partida)</title>
<style>
  :root{
    --bg:#0a0c10; --ink:#e9f0ff; --muted:#a7b0c8;
    --p1:#33d6ff; --p2:#ff6b6b; --hp1:#2ecc71; --hp2:#ff4a6e;
    --panel:#0e121a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% -10%,#101523,#07090d),var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  canvas{position:fixed;inset:0;width:100vw;height:100vh;touch-action:none;pointer-events:none;z-index:1;display:block}

  /* HUD */
  .hud{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr;z-index:5;pointer-events:none}
  .top{display:flex;gap:.75rem;justify-content:space-between;align-items:center;padding:.6rem 1rem;pointer-events:auto}
  .badge{display:flex;align-items:center;gap:.5rem;background:rgba(15,20,32,.7);border:1px solid #1e2740;border-radius:999px;padding:.35rem .6rem;backdrop-filter:blur(6px)}
  .meter{--c:#2ecc71;height:10px;width:min(36vw,240px);background:#0b1020;border:1px solid #283153;border-radius:999px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,var(--c),transparent);box-shadow:0 0 10px var(--c)}
  .score{font-weight:800;letter-spacing:.3px;min-width:80px;text-align:right}
  .score.small{font-size:.85rem;opacity:.9;min-width:auto}

  .center{display:grid;place-items:center;pointer-events:auto}
  .card{width:min(520px,92vw);padding:18px;border-radius:16px;border:1px solid #232a45;background:linear-gradient(180deg,rgba(14,18,26,.9),rgba(10,12,16,.9));box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .title{margin:.2rem 0 0;font-size:1.7rem;font-weight:900;letter-spacing:.4px;text-align:center}
  .muted{margin:.25rem 0 .8rem;color:var(--muted);text-align:center}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:8px}
  input,button{appearance:none;border:1px solid #2a3358;background:#11162a;color:var(--ink);padding:.85rem 1rem;border-radius:12px;font-weight:800;cursor:pointer}
  input{min-width:220px}
  button:hover{transform:translateY(-1px)} button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#00e7ff,#33b6ff);color:#051018;border-color:#00e7ff}
  .ghost{background:#0e1426}

  /* Overlay de mensajes superiores (cuentas) */
  .overlay{position:fixed;left:0;right:0;top:0;display:none;z-index:10;pointer-events:none;color:#fff;text-shadow:0 0 18px rgba(0,231,255,.6), 0 0 28px rgba(138,43,255,.5);font-weight:900;padding:12px 16px;text-align:left}
  .overlay .big{font-size:min(16vw,120px);letter-spacing:.02em;line-height:1}
  .overlay .small{font-size:min(4.5vw,22px);opacity:.9}

  .toast{position:fixed;left:50%;transform:translateX(-50%);top:56px;z-index:12;color:#fff;font-weight:800;text-shadow:0 0 10px rgba(0,231,255,.5);pointer-events:none}

  /* Controles móvil */
  .mobileBar{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:calc(env(safe-area-inset-bottom,0) + 12px);
    width:min(560px,96vw);
    display:none;gap:.8rem;z-index:11;padding:.6rem;
    background:rgba(10,14,24,.55);border:1px solid #202842;border-radius:16px;
    box-shadow:0 12px 40px rgba(0,0,0,.45), inset 0 0 20px rgba(255,255,255,.04);
    backdrop-filter:blur(10px);pointer-events:auto;align-items:center
  }
  .mobileCol{display:flex;align-items:center;gap:.6rem;flex:1}
  .dpad{display:grid;grid-template-columns:repeat(3,56px);grid-template-rows:repeat(3,56px);place-items:center;gap:.35rem;justify-content:center;align-content:center;margin-left:.2rem}
  .dpad .spacer{width:56px;height:56px;opacity:0}
  .mobileBtn{width:56px;height:56px;font-weight:900;border-radius:12px;border:1px solid #2a3358;background:#0f1426;color:var(--ink);box-shadow:0 6px 18px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;user-select:none}
  .mobileBtn.primary{width:auto;height:56px;min-width:120px;padding:0 18px;background:linear-gradient(180deg,#00e7ff,#33b6ff);color:#061119;border-color:#00e7ff}
  @media (max-width:780px){ .mobileBar{display:flex} }
</style>
</head>
<body>
  <canvas id="game"></canvas>

  <!-- Lobby minimal -->
  <div class="hud">
    <div class="top">
      <div class="badge">
        <strong>Jugadores</strong>
        <span id="lblPlayers" class="score">0</span>
      </div>
      <div class="badge"><span id="lblRoom" class="score small">Sala: –</span></div>
    </div>

    <div class="center">
      <div id="menu" class="card">
        <h1 class="title">BEYBLADE NEON – ONLINE</h1>
        <div class="muted">Escribe tu <b>apodo</b> y toca <b>ENTRAR AL JUEGO</b>. La partida inicia automáticamente cuando hay <b>2+</b> jugadores (máx 10). En móvil usa el D-Pad.</div>
        <div class="row">
          <input id="nick" placeholder="Tu apodo">
          <button id="btnJoin" class="primary" type="button">ENTRAR AL JUEGO</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay de cuentas -->
  <div id="count" class="overlay">
    <div id="countBig" class="big">3</div>
    <div id="countSmall" class="small">prepárate…</div>
  </div>

  <!-- Controles móvil -->
  <div class="mobileBar" id="mobileBar" aria-label="Controles táctiles">
    <div class="mobileCol" style="flex:1.4">
      <div class="dpad" role="group" aria-label="D-Pad">
        <div class="spacer"></div>
        <button id="btnUp"    class="mobileBtn" type="button" aria-label="Arriba">▲</button>
        <div class="spacer"></div>

        <button id="btnLeft"  class="mobileBtn" type="button" aria-label="Izquierda">◀</button>
        <div class="spacer"></div>
        <button id="btnRight" class="mobileBtn" type="button" aria-label="Derecha">▶</button>

        <div class="spacer"></div>
        <button id="btnDown"  class="mobileBtn" type="button" aria-label="Abajo">▼</button>
        <div class="spacer"></div>
      </div>
    </div>
    <div class="mobileCol" style="justify-content:flex-end;flex:1">
      <button id="btnPower" class="mobileBtn primary" type="button">LANZAR</button>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script type="module">
/* ================== Firebase (CDN) ================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, push, set, update, remove, onValue, get, runTransaction, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

/* Tu configuración */
const firebaseConfig = {
  apiKey: "AIzaSyDal6PPI7n6qF4tVOV2pxav4noWWoHhKms",
  authDomain: "juegokbros-738c3.firebaseapp.com",
  databaseURL: "https://juegokbros-738c3-default-rtdb.firebaseio.com",
  projectId: "juegokbros-738c3",
  storageBucket: "juegokbros-738c3.firebasestorage.app",
  messagingSenderId: "1003073646098",
  appId: "1:1003073646098:web:1c7238d619e5208990f2cb",
  measurementId: "G-EGQQH87SLJ"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ================== Util/UI ================== */
const $ = s=>document.querySelector(s);
const cvs = $('#game'); const ctx = cvs.getContext('2d');
const hud = {
  menu: $('#menu'), lblPlayers: $('#lblPlayers'), lblRoom: $('#lblRoom'),
  overlay: $('#count'), countBig: $('#countBig'), countSmall: $('#countSmall'),
  toast: $('#toast'),
  btnJoin: $('#btnJoin'), nick: $('#nick'),
  btnU: $('#btnUp'), btnD: $('#btnDown'), btnL: $('#btnLeft'), btnR: $('#btnRight'), btnP: $('#btnPower')
};
function showMenu(b){ hud.menu.style.display = b?'block':'none'; }
function overlay(txt, sub){ hud.overlay.style.display='block'; hud.countBig.textContent=txt; hud.countSmall.textContent=sub||''; }
function hideOverlay(){ hud.overlay.style.display='none'; }
let toastT=0; function showToast(msg){ toastT=2; hud.toast.textContent=msg; hud.toast.style.display='block'; }
function stepToast(dt){ if(toastT>0){ toastT-=dt; if(toastT<=0) hud.toast.style.display='none'; } }
function vibrate(ms=30){ try{ navigator.vibrate && navigator.vibrate(ms); }catch{} }

/* ================== Lobby/Sala (Realtime DB) ================== */
const lobbyRef = ref(db,'lobby/jugadores');
const roomsRef = ref(db,'partidas');

let myId=null, myNick=null, roomId=null, isHost=false;

/* Reglas de la sala:
   estado: 'esperando' | 'pre' | 'lanzamiento' | 'jugando' | 'fin'
   tPre: timestamp (comienza en 10s) / tGo: timestamp (ventana de 3s)
   jugadores/<id>: {nick, alive, hp, x,y,vx,vy,spinRPM,ready?}
   max: 10, jugCount
*/

async function joinLobbyAndRoom(){
  myNick = (hud.nick.value||'').trim();
  if(!myNick){ alert('Escribe tu apodo'); return; }
  showMenu(false);

  // Añadirme al lobby (presencia)
  const node = push(lobbyRef); myId=node.key;
  await set(node,{nick:myNick, ts:serverTimestamp()});
  onDisconnect(node).remove();

  // Buscar sala en 'esperando' con <10; si no hay, crear
  const snap = await get(roomsRef); let chosen=null;
  if(snap.exists()){
    snap.forEach(s=>{
      const v=s.val();
      if(v.estado==='esperando' && (v.jugCount||0)<10){ chosen={id:s.key,v}; return true; }
    });
  }
  if(!chosen){
    const newRoom = push(roomsRef);
    roomId = newRoom.key; isHost=true;
    await set(newRoom,{estado:'esperando',jugCount:0,max:10, jugadores:{}});
  }else{ roomId=chosen.id; isHost=false; }
  hud.lblRoom.textContent = 'Sala: '+roomId;

  // Unirme a la sala si está en 'esperando'; si no, espero otra
  const r = await get(ref(db,`partidas/${roomId}/estado`));
  if(r.val()!=='esperando'){ alert('La sala ya está en curso, intenta de nuevo'); location.reload(); return; }

  // Crear mi entrada de jugador
  await set(ref(db,`partidas/${roomId}/jugadores/${myId}`),{
    nick:myNick, alive:true, hp:1000, x:0,y:0,vx:0,vy:0,spinRPM:0
  });
  onDisconnect(ref(db,`partidas/${roomId}/jugadores/${myId}`)).remove();
  await runTransaction(ref(db,`partidas/${roomId}/jugCount`),curr=>(curr||0)+1);

  // Si soy host, cuando haya 2+ programo la pre-cuenta (10s)
  onValue(ref(db,`partidas/${roomId}`), async s=>{
    const v=s.val()||{};
    const count=v.jugCount||0;
    hud.lblPlayers.textContent = count;
    if(isHost && v.estado==='esperando' && count>=2){
      // programar pre (10s)
      const now=Date.now(); await update(ref(db,`partidas/${roomId}`),{
        estado:'pre', tPre: now + 10000
      });
    }
  });

  // Escuchar cambios de estado
  onValue(ref(db,`partidas/${roomId}`), s=>{
    const v=s.val()||{};
    if(!v.estado) return;
    if(v.estado==='esperando'){ overlay('ESPERANDO','Se necesitan 2+ jugadores'); }
    if(v.estado==='pre'){
      // cuenta regresiva 10s
      const tick=()=>{ 
        const left = Math.max(0, Math.ceil((v.tPre - Date.now())/1000));
        overlay(String(left), 'La partida inicia en…');
        if(left<=0){
          if(isHost){
            const now=Date.now();
            update(ref(db,`partidas/${roomId}`), { estado:'lanzamiento', tGo: now + 3000 });
          }
        } else setTimeout(tick, 250);
      }; tick();
    }
    if(v.estado==='lanzamiento'){
      const tick=()=>{
        const left = Math.max(0, Math.ceil((v.tGo - Date.now())/1000));
        overlay(left>0?String(left):'GO!','Presiona ESPACIO / LANZAR');
        if(left<=0) hideOverlay(); else setTimeout(tick, 120);
      }; tick();
      // Permitir lanzar
      game.phase='window';
    }
    if(v.estado==='jugando'){
      hideOverlay(); game.phase='battle';
    }
    if(v.estado==='fin'){
      // Mostrar ganador y reiniciar a esperando
      if(v.winnerNick){ announceWinner(v.winnerNick); }
    }
  });

  // Iniciar juego local
  startLocalGame();
}

/* ================== Juego local (multijugador simple con sync) ================== */
const TAU=Math.PI*2;
let W=0,H=0,DPR=1; function resize(){ DPR=Math.min(2,window.devicePixelRatio||1); W=cvs.width=Math.floor(innerWidth*DPR); H=cvs.height=Math.floor((Math.max(document.documentElement.clientHeight,window.innerHeight||0))*DPR); }
resize(); addEventListener('resize',resize);

const arena={cx:0,cy:0,r:0,innerR:0}; function setupArena(){ arena.cx=W/2; arena.cy=H/2; arena.r=Math.min(W,H)*0.40; arena.innerR=arena.r*0.94; }

const rand=(a,b)=>a+Math.random()*(b-a), clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* partículas (chispas/serpentinas) */
const sparks=[]; function spawnSparks(x,y,n=14,hue=35){ for(let i=0;i<n;i++){ sparks.push({x,y,vx:Math.cos(rand(0,TAU))*rand(2,6),vy:Math.sin(rand(0,TAU))*rand(2,6),life:rand(12,24),t:0,hue:hue+rand(-10,10)});} }
function drawSparks(dt){ ctx.save(); ctx.globalCompositeOperation='lighter';
  for(let i=sparks.length-1;i>=0;i--){ const s=sparks[i]; s.t+=dt*60; if(s.t>s.life){ sparks.splice(i,1); continue;}
    s.x+=s.vx*dt*60; s.y+=s.vy*dt*60; s.vy+=0.02*dt*60; const a=1-s.t/s.life, r=3+(1-a)*3;
    ctx.fillStyle=`hsla(${s.hue},100%,60%,${a})`; ctx.beginPath(); ctx.arc(s.x,s.y,r,0,TAU); ctx.fill();
    ctx.fillStyle=`rgba(255,255,255,${a*0.8})`; ctx.beginPath(); ctx.arc(s.x,s.y,r*0.4,0,TAU); ctx.fill(); }
  ctx.restore(); }

/* confeti ganador */
const confetti=[]; function startConfetti(){ for(let i=0;i<220;i++){ confetti.push({x:rand(0,W), y:rand(-H*0.3,-20), vy:rand(1,3), vx:rand(-0.8,0.8), h:Math.floor(Math.random()*360)});} }
function drawConfetti(dt){ for(let i=confetti.length-1;i>=0;i--){ const c=confetti[i]; c.y+=c.vy*dt*60; c.x+=c.vx*dt*60; if(c.y>H+20) confetti.splice(i,1); ctx.fillStyle=`hsl(${c.h},100%,60%)`; ctx.fillRect(c.x,c.y,4,8);} }

/* Beyblade sprite ligero */
function makeBladeSprite(radius, baseColor, accentColor){
  const size=Math.ceil(radius*2.4), c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d'); g.translate(size/2,size/2); const r=radius;
  const grad=g.createRadialGradient(0,0,r*0.2,0,0,r); grad.addColorStop(0,'#aab6c8'); grad.addColorStop(0.45,'#62708a'); grad.addColorStop(1,'#1a2230');
  g.fillStyle=grad; g.beginPath(); g.arc(0,0,r,0,TAU); g.fill();
  g.save(); g.fillStyle=accentColor; for(let i=0;i<9;i++){ g.rotate(TAU/9); g.beginPath(); g.moveTo(r*0.78,0); g.lineTo(r*1.05,r*0.12); g.lineTo(r*0.92,-r*0.12); g.closePath(); g.fill(); } g.restore();
  g.lineWidth=6; g.strokeStyle='rgba(255,255,255,.25)'; g.beginPath(); g.arc(0,0,r*0.82,0,TAU); g.stroke();
  g.save(); g.fillStyle=baseColor; for(let i=0;i<3;i++){ g.rotate(TAU/3); g.beginPath(); g.moveTo(r*0.36,0); g.quadraticCurveTo(r*0.9,r*0.22,r*0.72,-r*0.18); g.lineTo(r*0.9,0); g.closePath(); g.fill(); } g.restore();
  const core=g.createRadialGradient(-r*0.1,-r*0.1,r*0.1,0,0,r*0.46); core.addColorStop(0,'#0f1320'); core.addColorStop(1,'#0a0e18'); g.fillStyle=core; g.beginPath(); g.arc(0,0,r*0.46,0,TAU); g.fill();
  const halo=g.createRadialGradient(0,0,r*0.9,0,0,r*1.18); halo.addColorStop(0,'rgba(0,0,0,0)'); halo.addColorStop(1,'rgba(255,255,255,0.08)'); g.fillStyle=halo; g.beginPath(); g.arc(0,0,r*1.18,0,TAU); g.fill();
  return c;
}

/* Modelo jugador (local y remotos) */
class Blade{
  constructor(o){ Object.assign(this,{
    id:'', nick:'', x:0,y:0,vx:0,vy:0,ang:0, spinRPM:0,maxRPM:4500,
    hp:1000,maxHP:1000, baseRadius:28,radius:28,mass:1, color:'#fff',accent:'#88aaff',
    launching:true, hasLaunched:false, alive:true, boostCD:0, sprite:null
  },o); }
  ensure(){ if(!this.sprite) this.sprite=makeBladeSprite(this.baseRadius,this.color,this.accent); }
  fairLaunch(angle){ const fixedSpeed=8.5, fixedRPM=this.maxRPM*0.85; this.vx=Math.cos(angle)*fixedSpeed; this.vy=Math.sin(angle)*fixedSpeed; this.spinRPM=fixedRPM; this.launching=false; this.hasLaunched=true; }
  applyBoost(dx,dy){ if(this.boostCD>0) return false; const m=Math.hypot(dx,dy)||1, nx=dx/m, ny=dy/m; const str=3.2; this.vx+=nx*str; this.vy+=ny*str; spawnSparks(this.x+nx*this.radius, this.y+ny*this.radius, 12, 45); this.boostCD=0.75; vibrate(15); return true; }
  takeDamage(d){ this.hp=Math.max(0,this.hp-d); if(this.hp<=0){ this.alive=false; } }
  step(dt){
    this.boostCD=Math.max(0,this.boostCD-dt);
    if(this.launching || !this.alive) return;
    const k=Math.pow(1-0.65*0.001, dt*1000); this.vx*=k; this.vy*=k;
    this.x+=this.vx*dt*60; this.y+=this.vy*dt*60; this.ang+=(this.spinRPM/60)*TAU*dt;
    const speed=Math.hypot(this.vx,this.vy); const baseDecay=70, velDecay=10*speed; this.spinRPM=Math.max(0,this.spinRPM-(baseDecay+velDecay)*dt);
    const dx=this.x-arena.cx, dy=this.y-arena.cy, d=Math.hypot(dx,dy);
    if(d>arena.innerR-this.radius){
      const nx=dx/d, ny=dy/d, overlap=d-(arena.innerR-this.radius);
      this.x-=nx*overlap; this.y-=ny*overlap; const vn=this.vx*nx+this.vy*ny; this.vx-=1.6*vn*nx; this.vy-=1.6*vn*ny;
      this.spinRPM=Math.max(0,this.spinRPM-120); this.takeDamage(10); spawnSparks(this.x,this.y,16,28);
    }
    if(d>arena.r+10) { this.alive=false; }
    if(this.spinRPM<=60 && Math.hypot(this.vx,this.vy)<0.1) { this.alive=false; }
  }
  draw(){
    this.ensure();
    const spinFactor=Math.min(1,this.spinRPM/2000);
    if(spinFactor>0.1){ ctx.save(); ctx.globalAlpha=0.12*spinFactor; ctx.strokeStyle='rgba(255,255,255,.5)'; ctx.lineWidth=6; ctx.beginPath(); ctx.arc(this.x,this.y,this.radius*0.9,0,TAU); ctx.stroke(); ctx.restore(); }
    ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.ang); const s=this.sprite, scale=this.radius/this.baseRadius; ctx.drawImage(s,-s.width*0.5*scale,-s.height*0.5*scale,s.width*scale,s.height*scale); ctx.restore();
    // barra HP
    const barW=100, barH=10, pad=this.radius+18, ratio=this.hp/this.maxHP; ctx.save(); ctx.translate(this.x,this.y-pad);
    ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(-barW/2,-barH/2,barW,barH);
    ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=2; ctx.strokeRect(-barW/2,-barH/2,barW,barH);
    ctx.fillStyle = (this.id===myId)? getComputedStyle(document.documentElement).getPropertyValue('--hp1') : getComputedStyle(document.documentElement).getPropertyValue('--hp2'); ctx.fillRect(-barW/2,-barH/2,barW*ratio,barH);
    ctx.restore();
    // nombre
    ctx.save(); ctx.font=`${12*DPR}px system-ui`; ctx.textAlign='center'; ctx.fillStyle='#cfe5ff'; ctx.fillText(this.nick, this.x, this.y-pad-12*DPR); ctx.restore();
  }
}

const game={ phase:'menu', blades:new Map(), angle:-Math.PI/3, last:0 };

function resetPositions(){
  let i=0; const n=game.blades.size; const rad=arena.r*0.6;
  for(const b of game.blades.values()){
    const a = -Math.PI/2 + (i/(Math.max(1,n)))*TAU*0.6 - 0.3;
    b.x = arena.cx + Math.cos(a)*rad*0.3;
    b.y = arena.cy + Math.sin(a)*rad*0.3;
    b.vx=b.vy=0; b.ang=0; b.spinRPM=0; b.hp=b.maxHP=1000; b.alive=true; b.launching=true; b.hasLaunched=false; b.boostCD=0;
    i++;
  }
}

function collide(a,b){
  if(!a.alive||!b.alive) return;
  const dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy), minD=a.radius+b.radius;
  if(d<=0||d>minD) return;
  const nx=dx/d, ny=dy/d, overlap=minD-d; a.x-=nx*overlap*0.5; a.y-=ny*overlap*0.5; b.x+=nx*overlap*0.5; b.y+=ny*overlap*0.5;
  const va=a.vx*nx+a.vy*ny, vb=b.vx*nx+b.vy*ny, m1=a.mass,m2=b.mass,k=0.9;
  const va2=(va*(m1-m2)+2*m2*vb)/(m1+m2), vb2=(vb*(m2-m1)+2*m1*va)/(m1+m2);
  a.vx+=(va2-va)*nx*k; a.vy+=(va2-va)*ny*k; b.vx+=(vb2-vb)*nx*k; b.vy+=(vb2-vb)*ny*k;
  const rel=Math.abs(va-vb), baseRPM=60+35*rel, baseHP=12+7*rel;
  a.spinRPM=Math.max(0,a.spinRPM-baseRPM); b.spinRPM=Math.max(0,b.spinRPM-baseRPM);
  a.takeDamage(baseHP); b.takeDamage(baseHP);
  spawnSparks((a.x+b.x)/2,(a.y+b.y)/2, 22, Math.floor(Math.random()*360));
}

/* Dibujo arena */
function drawArena(){ ctx.clearRect(0,0,W,H); ctx.save(); ctx.translate(arena.cx,arena.cy);
  for(let i=6;i>=1;i--){ const r=arena.r*(i/6); ctx.beginPath(); ctx.arc(0,0,r,0,TAU);
    const g=ctx.createRadialGradient(0,0,r*0.2,0,0,r); g.addColorStop(0,'#0c1120'); g.addColorStop(1,'#080b12'); ctx.fillStyle=g; ctx.fill();
    ctx.strokeStyle = i%2 ? 'rgba(0,231,255,.30)' : 'rgba(138,43,255,.26)'; ctx.lineWidth = i===6?6:4; if(i===5) ctx.setLineDash([10,10]); else ctx.setLineDash([]); ctx.shadowColor = i%2?'rgba(0,231,255,.45)':'rgba(138,43,255,.4)'; ctx.shadowBlur=8; ctx.stroke(); ctx.shadowBlur=0; }
  ctx.beginPath(); ctx.arc(0,0,arena.innerR,0,TAU); ctx.setLineDash([8,10]); ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=2; ctx.stroke(); ctx.setLineDash([]); ctx.restore(); }

/* -------------------- Sync con Firebase -------------------- */
function startLocalGame(){
  setupArena();
  // Cargar mis y otros jugadores
  onValue(ref(db,`partidas/${roomId}/jugadores`), s=>{
    const obj = s.val()||{};
    // crear/actualizar blades
    for(const id in obj){
      const p = obj[id];
      if(!game.blades.has(id)){
        game.blades.set(id, new Blade({id, nick:p.nick, color:(id===myId?'#33d6ff':'#ff6b6b'), accent:(id===myId?'#7ad8ff':'#ffb4b4')}));
      }
      const b = game.blades.get(id);
      if(id!==myId){ // remotos: acoplar estado
        b.x=p.x??b.x; b.y=p.y??b.y; b.vx=p.vx??b.vx; b.vy=p.vy??b.vy; b.spinRPM=p.spinRPM??b.spinRPM; b.hp=p.hp??b.hp; b.alive=p.alive!==false; b.launching = p.spinRPM<=0 && b.alive && game.phase!=='battle';
      }
      b.nick=p.nick||b.nick;
    }
    // eliminar los que ya no están
    for(const id of [...game.blades.keys()]){ if(!obj[id]) game.blades.delete(id); }
    resetPositions();
  });

  // Inicia el loop
  game.phase='esperando';
}

/* envío periódico de mi estado (10Hz) */
setInterval(async ()=>{
  if(!roomId||!myId) return;
  const me = game.blades.get(myId); if(!me) return;
  await update(ref(db,`partidas/${roomId}/jugadores/${myId}`),{
    x:me.x,y:me.y,vx:me.vx,vy:me.vy,spinRPM:me.spinRPM,hp:Math.round(me.hp),alive:me.alive
  });
  // Comprobar fin: si soy host y queda 1 vivo, cerrar ronda
  if(isHost){
    const alive = [...game.blades.values()].filter(b=>b.alive);
    const stateSnap = await get(ref(db,`partidas/${roomId}/estado`));
    if(stateSnap.val()==='jugando' && alive.length<=1){
      const win = alive[0]; const winnerNick = win? win.nick : 'Nadie';
      await update(ref(db,`partidas/${roomId}`), { estado:'fin', winnerNick });
      setTimeout(async ()=>{
        // reset a esperando (permitir que se sumen nuevos)
        const room = ref(db,`partidas/${roomId}`);
        await update(room, { estado:'esperando', tPre:null, tGo:null, winnerNick:null });
      }, 5000);
    }
  }
}, 100);

/* -------------------- Input -------------------- */
const keys=new Set();
addEventListener('keydown',e=>{
  if(['w','a','s','d','W','A','S','D',' ','ArrowLeft','ArrowRight'].includes(e.key)) e.preventDefault();
  keys.add(e.key);
  const me = game.blades.get(myId); if(!me) return;
  // Boosts
  if(e.key==='w'||e.key==='W') me.applyBoost(0,-1);
  if(e.key==='s'||e.key==='S') me.applyBoost(0, 1);
  if(e.key==='a'||e.key==='A') me.applyBoost(-1,0);
  if(e.key==='d'||e.key==='D') me.applyBoost( 1,0);
  // Lanzar (ventana)
  if(e.key===' ' && game.phase==='window' && me.launching){ me.fairLaunch(game.angle); vibrate(30); }
});
addEventListener('keyup',e=>{ keys.delete(e.key); });

/* móvil */
function t(btn, fn){ btn.addEventListener('touchstart', e=>{e.preventDefault(); fn();}, {passive:false}); }
t(hud.btnU, ()=>{ const me = game.blades.get(myId); me && me.applyBoost(0,-1); });
t(hud.btnD, ()=>{ const me = game.blades.get(myId); me && me.applyBoost(0, 1); });
t(hud.btnL, ()=>{ const me = game.blades.get(myId); me && me.applyBoost(-1,0); });
t(hud.btnR, ()=>{ const me = game.blades.get(myId); me && me.applyBoost( 1,0); });
t(hud.btnP, ()=>{ const me = game.blades.get(myId); if(game.phase==='window' && me?.launching){ me.fairLaunch(game.angle); vibrate(40); }});

/* -------------------- Loop -------------------- */
function announceWinner(name){
  overlay('¡'+name+'!','CAMPEÓN');
  startConfetti();
  setTimeout(()=>{ hideOverlay(); }, 5000);
}

function drawAim(b,angle,col){ ctx.save(); ctx.strokeStyle=col; ctx.globalAlpha=.9; ctx.lineWidth=4; ctx.shadowColor=col; ctx.shadowBlur=10;
  ctx.beginPath(); ctx.moveTo(b.x,b.y); ctx.lineTo(b.x+Math.cos(angle)*160, b.y+Math.sin(angle)*160); ctx.stroke(); ctx.restore(); }

function loop(t){
  const dt=Math.min(0.033,(t-game.last||16)/1000); game.last=t;

  drawArena();

  // fases locales:
  if(game.phase==='window'){
    const me=game.blades.get(myId); if(me?.launching) drawAim(me, game.angle,'#33d6ff');
  }

  // pasos y colisiones
  const arr=[...game.blades.values()];
  for(const b of arr) b.step(dt);
  for(let i=0;i<arr.length;i++) for(let j=i+1;j<arr.length;j++) collide(arr[i],arr[j]);

  for(const b of arr) b.draw();
  drawSparks(dt); drawConfetti(dt); stepToast(dt);

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* -------------- Botón de entrar -------------- */
hud.btnJoin.onclick = joinLobbyAndRoom;

/* init */
setupArena(); showMenu(true);
</script>
</body>
</html>
