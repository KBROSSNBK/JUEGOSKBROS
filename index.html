<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>Beyblade Neon (Online)</title>
<style>
  :root{
    --bg:#0a0c10; --panel:#0e121a; --ink:#e9f0ff; --muted:#a7b0c8;
    --p1:#33d6ff; --p2:#ff6b6b;
    --hp1:#2ecc71; --hp2:#ff4a6e;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% -10%,#101523,#07090d),var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden}
  canvas{position:fixed;inset:0;width:100vw;height:100vh;touch-action:none;pointer-events:none;z-index:1;display:block}

  .hud{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr;z-index:5;pointer-events:none}
  .top{display:flex;gap:.75rem;justify-content:space-between;align-items:center;padding:.75rem 1rem;pointer-events:auto}
  .badge{display:flex;align-items:center;gap:.5rem;background:rgba(15,20,32,.7);border:1px solid #1e2740;border-radius:999px;padding:.45rem .7rem;backdrop-filter:blur(6px)}
  .meter{--c:#2ecc71;height:10px;width:min(36vw,240px);background:#0b1020;border:1px solid #283153;border-radius:999px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,var(--c),transparent);box-shadow:0 0 10px var(--c);transition:width .12s}
  .score{font-weight:800;letter-spacing:.3px;min-width:80px;text-align:right}
  .score.small{font-size:.85rem;opacity:.9;min-width:auto}
  .center{display:grid;place-items:center;pointer-events:auto}
  .card{width:min(560px,94vw);padding:18px;border-radius:16px;border:1px solid #232a45;background:linear-gradient(180deg,rgba(14,18,26,.9),rgba(10,12,16,.9));box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .title{margin:.2rem 0 0;font-size:1.7rem;font-weight:900;letter-spacing:.4px;text-align:center}
  .muted{margin:.25rem 0 .6rem;color:var(--muted);text-align:center}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;margin-top:10px}
  button{appearance:none;border:1px solid #2a3358;background:#11162a;color:var(--ink);padding:.9rem 1.1rem;border-radius:12px;font-weight:800;cursor:pointer;transition:transform .06s ease, box-shadow .2s, border-color .2s;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  button:hover{transform:translateY(-1px)} button:active{transform:translateY(1px)}
  .primary{background:linear-gradient(180deg,#00e7ff,#33b6ff);color:#051018;border-color:#00e7ff;box-shadow:0 0 20px rgba(0,231,255,.35), inset 0 0 10px rgba(255,255,255,.2)}
  .ghost{background:#0e1426}

  .fab{position:fixed;right:12px;bottom:12px;z-index:6;pointer-events:auto}
  @media (max-width:780px){ .fab{bottom:calc(env(safe-area-inset-bottom,0) + 98px);} }

  .overlay{position:fixed;left:0;right:0;top:0;display:none;z-index:10;pointer-events:none;color:#fff;text-shadow:0 0 18px rgba(0,231,255,.6), 0 0 28px rgba(138,43,255,.5);font-weight:900;padding:12px 16px;text-align:left}
  .overlay .big{font-size:min(16vw,120px);letter-spacing:.02em;line-height:1}
  .overlay .small{font-size:min(4.5vw,22px);opacity:.9}

  .win{position:fixed; inset:0; display:none; z-index:15; pointer-events:none; display:grid; place-items:center; text-align:center; color:#fff; text-shadow:0 0 22px rgba(0,231,255,.6), 0 0 34px rgba(138,43,255,.5)}
  .win .title{font-size:min(12vw,72px); font-weight:1000; letter-spacing:.6px; margin:0}
  .win .sub{ font-size:min(5vw,22px); opacity:.92; margin-top:6px }

  .legend{position:fixed;left:10px;bottom:10px;font-size:12px;color:#9fb0ff;opacity:.8;z-index:4}
  @media (max-width:780px){ .legend{display:none} }
  .toast{position:fixed;left:50%;transform:translateX(-50%);top:56px;z-index:12;color:#fff;font-weight:800;text-shadow:0 0 10px rgba(0,231,255,.5);pointer-events:none}

  .mobileBar{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom,0) + 12px);width:min(560px, 96vw);display:none;gap:.8rem;z-index:11;padding:.6rem;background:rgba(10,14,24,.55);border:1px solid #202842;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.45), inset 0 0 20px rgba(255,255,255,.04);backdrop-filter: blur(10px);pointer-events:auto;align-items:center}
  .mobileCol{display:flex;align-items:center;gap:.6rem;flex:1}
  .dpad{display:grid;grid-template-columns:repeat(3,56px);grid-template-rows:repeat(3,56px);place-items:center;gap:.35rem;justify-content:center;align-content:center;margin-left:.2rem}
  .dpad .spacer{width:56px;height:56px;opacity:0}
  .mobileBtn{width:56px;height:56px;font-weight:900;border-radius:12px;border:1px solid #2a3358;background:#0f1426;color:var(--ink);box-shadow:0 6px 18px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;user-select:none}
  .mobileBtn:active{transform:translateY(1px)}
  .mobileBtn.primary{width:auto;height:56px;padding:0 18px;min-width:120px;background:linear-gradient(180deg,#00e7ff,#33b6ff);color:#061119;border-color:#00e7ff}
  @media (max-width:780px){ .mobileBar{display:flex} }

  @media (max-width:520px){ .top{flex-direction:column;align-items:stretch;gap:.5rem} .badge{justify-content:space-between} .meter{width:52vw} }
</style>
</head>
<body>
  <canvas id="game"></canvas>

  <div class="hud">
    <div class="top">
      <div class="badge">
        <strong id="p1Name">P1</strong>
        <div class="meter"><div id="m1" class="fill" style="--c:var(--hp1);width:100%"></div></div>
        <span id="hp1" class="score">HP 100</span>
        <span id="boost1" class="score small">Boost: listo</span>
      </div>
      <div class="badge" id="modeBadge">
        <strong id="modeLabel">LOCAL</strong>
        <div class="score small" id="roomInfo" style="min-width:auto"></div>
      </div>
    </div>

    <div class="center">
      <div id="menu" class="card">
        <h1 class="title">BEYBLADE NEON</h1>
        <div class="muted">
          <b>Local:</b> CPU / 2 Jugadores ‚îÉ <b>Online:</b> Lobby Firebase (2‚Äì10).<br>
          En <b>GO!</b> lanza con <b>Espacio</b> / bot√≥n. Boost <b>W/A/S/D</b> o D-Pad, cooldown <b>0,75s</b>.
        </div>
        <div class="row">
          <button id="btnP1"  class="primary" type="button">Local: P1 vs CPU</button>
          <button id="btn2P"  class="ghost"   type="button">Local: 2 Jugadores</button>
          <button id="btnON"  class="ghost"   type="button">Jugar Online (Firebase)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra m√≥vil -->
  <div class="mobileBar" id="mobileBar" aria-label="Controles t√°ctiles">
    <div class="mobileCol" style="flex:1.4">
      <div class="dpad" role="group" aria-label="D-Pad">
        <div class="spacer"></div>
        <button id="btnUp"    class="mobileBtn" type="button" aria-label="Arriba">‚ñ≤</button>
        <div class="spacer"></div>
        <button id="btnLeft"  class="mobileBtn" type="button" aria-label="Izquierda">‚óÄ</button>
        <div class="spacer"></div>
        <button id="btnRight" class="mobileBtn" type="button" aria-label="Derecha">‚ñ∂</button>
        <div class="spacer"></div>
        <button id="btnDown"  class="mobileBtn" type="button" aria-label="Abajo">‚ñº</button>
        <div class="spacer"></div>
      </div>
    </div>
    <div class="mobileCol" style="justify-content:flex-end;flex:1">
      <button id="btnPower" class="mobileBtn primary" type="button">LANZAR</button>
    </div>
  </div>

  <div class="fab">
    <button id="btnRestart" type="button">‚Üª Reiniciar</button>
  </div>

  <div id="count" class="overlay">
    <div id="countBig" class="big">3</div>
    <div id="countSmall" class="small">prep√°rate‚Ä¶</div>
  </div>

  <div id="win" class="win">
    <div>
      <h2 id="winTitle" class="title">¬°GANASTE!</h2>
      <div id="winSub" class="sub">Volviendo al men√∫‚Ä¶</div>
    </div>
  </div>

  <div class="legend">√çtems: üõ°Ô∏è Escudo ‚îÉ ü¶ç Gigante ‚îÉ üí• Da√±o+ ‚îÉ ‚ö° RPM+</div>
  <div id="toast" class="toast" style="display:none"></div>

  <!-- Firebase compat (simplifica uso sin bundlers) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
(() => {
/* ===================== CONFIG FIREBASE (TU PROYECTO) ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyDal6PPI7n6qF4tVOV2pxav4noWWoHhKms",
  authDomain: "juegokbros-738c3.firebaseapp.com",
  databaseURL: "https://juegokbros-738c3-default-rtdb.firebaseio.com",
  projectId: "juegokbros-738c3",
  storageBucket: "juegokbros-738c3.firebasestorage.app",
  messagingSenderId: "1003073646098",
  appId: "1:1003073646098:web:d7aaa73e2295a8ad90f2cb",
  measurementId: "G-6K63VZ2HQC"
};
let db=null;
try{ firebase.initializeApp(firebaseConfig); db=firebase.database(); }
catch(e){ console.warn('Firebase no inicializado:', e); }

/* ========= APODO ========= */
let NICK = localStorage.getItem('bey_nick') || '';
if(!NICK){
  NICK = prompt('Escribe tu APODO:', '') || 'Jugador';
  localStorage.setItem('bey_nick', NICK);
}
document.getElementById('p1Name').textContent = NICK;

/* ========= BASE JUEGO (arena + f√≠sicas + util) ========= */
const cvs = document.getElementById('game');
const ctx = cvs.getContext('2d');
const hud = {
  m1: document.getElementById('m1'), m2: document.getElementById('m2'),
  hp1: document.getElementById('hp1'), hp2: document.getElementById('hp2'),
  boost1: document.getElementById('boost1'), boost2: document.getElementById('boost2'),
  menu: document.getElementById('menu'),
  btnP1: document.getElementById('btnP1'), btn2P: document.getElementById('btn2P'), btnON: document.getElementById('btnON'),
  btnRestart: document.getElementById('btnRestart'),
  btnU: document.getElementById('btnUp'), btnD: document.getElementById('btnDown'), btnL: document.getElementById('btnLeft'), btnR: document.getElementById('btnRight'),
  btnP: document.getElementById('btnPower'),
  overlay: document.getElementById('count'), countBig: document.getElementById('countBig'), countSmall: document.getElementById('countSmall'),
  toast: document.getElementById('toast'),
  modeLabel: document.getElementById('modeLabel'), roomInfo: document.getElementById('roomInfo'),
  win: document.getElementById('win'), winTitle: document.getElementById('winTitle'), winSub: document.getElementById('winSub')
};

let W=0,H=0,DPR=1;
function viewportH(){ return Math.max(document.documentElement.clientHeight, window.innerHeight || 0); }
function resize(){ DPR=Math.min(2,window.devicePixelRatio||1); W=cvs.width=Math.floor(innerWidth*DPR); H=cvs.height=Math.floor(viewportH()*DPR); }
resize(); addEventListener('resize', resize);

const arena={cx:0,cy:0,r:0,innerR:0};
function setupArena(){ arena.cx=W/2; arena.cy=H/2; arena.r=Math.min(W,H)*0.40; arena.innerR=arena.r*0.94; }
const TAU=Math.PI*2, clamp=(v,a,b)=>Math.max(a,Math.min(b,v)), rand=(a,b)=>a+Math.random()*(b-a);
function vibrate(ms){ if('vibrate' in navigator) navigator.vibrate(ms); }

/* Toast */
let toastT=0; function showToast(msg){ toastT=2.0; hud.toast.textContent=msg; hud.toast.style.display='block'; }
function stepToast(dt){ if(toastT>0){ toastT-=dt; if(toastT<=0) hud.toast.style.display='none'; } }

/* Serpentinas (confetti simple) */
const confs=[]; function spawnConfettiBurst(cx,cy){ for(let i=0;i<220;i++){ const a=rand(0,TAU), sp=rand(1,6); confs.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,g:rand(0.02,0.06),t:rand(40,120),h:Math.floor(Math.random()*360)}); } }
function drawConfetti(dt){ ctx.save(); for(let i=confs.length-1;i>=0;i--){ const c=confs[i]; c.t-=dt*60; if(c.t<=0){confs.splice(i,1); continue;} c.x+=c.vx*dt*60; c.y+=c.vy*dt*60; c.vy+=c.g*dt*60; ctx.fillStyle=`hsl(${c.h},90%,60%)`; ctx.fillRect(c.x,c.y,3,6); } ctx.restore(); }

/* Chispas */
const sparks=[]; function spawnSparks(x,y, n=12, hue=35){ for(let i=0;i<n;i++){ sparks.push({x,y,vx:Math.cos(rand(0,TAU))*rand(2,6),vy:Math.sin(rand(0,TAU))*rand(2,6),life:rand(12,24),t:0,hue:hue+rand(-10,10)}); } }
function drawSparks(dt){ ctx.save(); ctx.globalCompositeOperation='lighter'; for(let i=sparks.length-1;i>=0;i--){ const s=sparks[i]; s.t+=dt*60; if(s.t>s.life){ sparks.splice(i,1); continue; } s.x+=s.vx*dt*60; s.y+=s.vy*dt*60; s.vy+=0.02*dt*60; const a=1-s.t/s.life, r=3+(1-a)*3; ctx.fillStyle=`hsla(${s.hue},100%,60%,${a})`; ctx.beginPath(); ctx.arc(s.x,s.y,r,0,TAU); ctx.fill(); ctx.fillStyle=`rgba(255,255,255,${a*0.8})`; ctx.beginPath(); ctx.arc(s.x,s.y,r*0.4,0,TAU); ctx.fill(); } ctx.restore(); }

/* √çtems compartidos */
const items=[]; const ITEM_TYPES=['shield','giant','damage','rpm'];
function spawnItemAt(x,y,type){ items.push({x,y,type,r:18,ttl:20}); }
function randomItem(){ return ITEM_TYPES[Math.floor(Math.random()*ITEM_TYPES.length)]; }
function drawItems(dt){ for(let i=items.length-1;i>=0;i--){ const it=items[i]; it.ttl-=dt; if(it.ttl<=0){ items.splice(i,1); continue; } let color='#fff', emoji='?'; if(it.type==='shield'){color='#4cd1ff';emoji='üõ°Ô∏è';} if(it.type==='giant'){color='#ff9f1c';emoji='ü¶ç';} if(it.type==='damage'){color='#ff4a6e';emoji='üí•';} if(it.type==='rpm'){color='#82ff6a';emoji='‚ö°';} ctx.save(); ctx.shadowColor=color; ctx.shadowBlur=15; ctx.fillStyle=color; ctx.globalAlpha=0.15 + 0.85*(Math.sin(performance.now()/200)+1)/2*0.3; ctx.beginPath(); ctx.arc(it.x,it.y,it.r,0,TAU); ctx.fill(); ctx.shadowBlur=0; ctx.globalAlpha=1; ctx.font=`${Math.floor(it.r*1.3)}px system-ui, emoji`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(emoji,it.x,it.y+1); ctx.restore(); } }
function tryPickup(b){ for(let i=items.length-1;i>=0;i--){ const it=items[i], d=Math.hypot(b.x-it.x,b.y-it.y); if(d<b.radius+it.r){ if(it.type==='shield'){ b.shield=Math.max(b.shield,6); showToast('üõ°Ô∏è Escudo'); } if(it.type==='giant'){ b.giant=Math.max(b.giant,6); showToast('ü¶ç Gigante'); } if(it.type==='damage'){ b.dmg=Math.max(b.dmg,6); showToast('üí• Da√±o+'); } if(it.type==='rpm'){ b.spinRPM=Math.min(b.maxRPM*1.05, b.spinRPM+700); showToast('‚ö° RPM+'); } spawnSparks(it.x,it.y,24, it.type==='rpm'? rand(80,140) : (it.type==='shield'? rand(180,220) : 30)); items.splice(i,1); vibrate(20); } } }

/* Sprites */
function makeBladeSprite(radius, baseColor, accentColor){
  const size=Math.ceil(radius*2.4), c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d'); g.translate(size/2,size/2); const r=radius;
  const grad=g.createRadialGradient(0,0,r*0.2,0,0,r); grad.addColorStop(0,'#aab6c8'); grad.addColorStop(0.45,'#62708a'); grad.addColorStop(1,'#1a2230'); g.fillStyle=grad; g.beginPath(); g.arc(0,0,r,0,TAU); g.fill();
  g.save(); g.fillStyle=accentColor; for(let i=0;i<9;i++){ g.rotate(TAU/9); g.beginPath(); g.moveTo(r*0.78,0); g.lineTo(r*1.05, r*0.12); g.lineTo(r*0.92,-r*0.12); g.closePath(); g.fill(); } g.restore();
  g.lineWidth=6; g.strokeStyle='rgba(255,255,255,.25)'; g.beginPath(); g.arc(0,0,r*0.82,0,TAU); g.stroke();
  g.save(); g.fillStyle=baseColor; for(let i=0;i<3;i++){ g.rotate(TAU/3); g.beginPath(); g.moveTo(r*0.36,0); g.quadraticCurveTo(r*0.9,r*0.22, r*0.72,-r*0.18); g.lineTo(r*0.9,0); g.closePath(); g.fill(); } g.restore();
  const coreGrad=g.createRadialGradient(-r*0.1,-r*0.1,r*0.1,0,0,r*0.46); coreGrad.addColorStop(0,'#0f1320'); coreGrad.addColorStop(1,'#0a0e18'); g.fillStyle=coreGrad; g.beginPath(); g.arc(0,0,r*0.46,0,TAU); g.fill();
  g.fillStyle='#9db3d6'; for(let i=0;i<6;i++){ const a=i*TAU/6; g.beginPath(); g.arc(Math.cos(a)*r*0.62, Math.sin(a)*r*0.62, 3, 0, TAU); g.fill(); }
  g.globalAlpha=.22; g.fillStyle='#fff'; g.beginPath(); g.ellipse(-r*0.25,-r*0.15, r*0.9, r*0.32, -0.7, 0, TAU); g.fill(); g.globalAlpha=1;
  const halo=g.createRadialGradient(0,0,r*0.9, 0,0,r*1.18); halo.addColorStop(0,'rgba(0,0,0,0)'); halo.addColorStop(1,'rgba(255,255,255,0.08)'); g.fillStyle=halo; g.beginPath(); g.arc(0,0,r*1.18,0,TAU); g.fill();
  return c;
}

/* ====== Entidades ====== */
class Blade{
  constructor(o){Object.assign(this,{
    id:'', name:'', x:0,y:0,vx:0,vy:0,ang:0,
    spinRPM:0,maxRPM:4500,
    hp:100,maxHP:100,
    baseRadius:28,radius:28,mass:1,color:'#33d6ff',accent:'#7ad8ff',
    hasLaunched:false,launching:true,alive:true,ringOut:false,
    shield:0,giant:0,dmg:0, boostCD:0, sprite:null
  },o);}
  ensureSprite(){ if(!this.sprite){ this.sprite=makeBladeSprite(this.baseRadius, this.color, this.accent); } }
  fairLaunch(angle){ const fixedSpeed=8.5, fixedRPM=this.maxRPM*0.85; this.vx=Math.cos(angle)*fixedSpeed; this.vy=Math.sin(angle)*fixedSpeed; this.spinRPM=fixedRPM; this.launching=false; this.hasLaunched=true; vibrate(20); }
  applyBoostDir(dx,dy){ if(this.boostCD>0) return false; const m=Math.hypot(dx,dy)||1, nx=dx/m, ny=dy/m; const strength=3.0; this.vx+=nx*strength; this.vy+=ny*strength; spawnSparks(this.x+nx*this.radius, this.y+ny*this.radius, 12, 45); this.boostCD=0.75; vibrate([10,50,10]); return true; }
  takeDamage(amount){ this.hp=Math.max(0,this.hp-amount); if(this.hp<=0) this.alive=false; }
  step(dt){
    this.boostCD=Math.max(0,this.boostCD-dt);
    if(this.giant>0){ this.giant-=dt; this.radius=this.baseRadius*1.4; } else { this.radius=this.baseRadius; }
    if(this.shield>0) this.shield-=dt; if(this.dmg>0) this.dmg-=dt;
    if(this.launching || !this.alive) return;
    const k=Math.pow(1-0.65*0.001, dt*1000); this.vx*=k; this.vy*=k; this.x+=this.vx*dt*60; this.y+=this.vy*dt*60; this.ang+=(this.spinRPM/60)*TAU*dt;
    const speed=Math.hypot(this.vx,this.vy); const baseDecay=70, velDecay=10*speed; this.spinRPM=Math.max(0,this.spinRPM-(baseDecay+velDecay)*dt);
    const dx=this.x-arena.cx, dy=this.y-arena.cy, d=Math.hypot(dx,dy);
    if(d>arena.innerR-this.radius){ const nx=dx/d, ny=dy/d, overlap=d-(arena.innerR-this.radius); this.x-=nx*overlap; this.y-=ny*overlap; const vn=this.vx*nx+this.vy*ny; this.vx-=1.6*vn*nx; this.vy-=1.6*vn*ny;
      let wallLossRPM=120, wallHP=6; if(this.shield>0){ wallLossRPM*=0.45; wallHP*=0.5; }
      this.spinRPM=Math.max(0,this.spinRPM-wallLossRPM); this.takeDamage(wallHP);
      spawnSparks(this.x,this.y,16,28); vibrate(10);
    }
    if(d>arena.r+10){ this.alive=false; this.ringOut=true; }
    if(this.spinRPM<=60 && Math.hypot(this.vx,this.vy)<0.1){ this.alive=false; }
  }
  draw(isLocal=false){
    this.ensureSprite();
    const spinFactor=Math.min(1,this.spinRPM/2000);
    if(spinFactor>0.1){ ctx.save(); ctx.globalAlpha=0.12*spinFactor; ctx.strokeStyle = isLocal? 'rgba(51,214,255,.7)' : 'rgba(255,107,107,.6)'; ctx.lineWidth=6; ctx.beginPath(); ctx.arc(this.x,this.y,this.radius*0.9,0,TAU); ctx.stroke(); ctx.restore(); }
    ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.ang);
    const s=this.sprite, scale=this.radius/this.baseRadius;
    ctx.drawImage(s,-s.width*0.5*scale,-s.height*0.5*scale,s.width*scale,s.height*scale);
    if(this.shield>0||this.dmg>0){ ctx.globalAlpha=0.5; ctx.shadowBlur=18; ctx.shadowColor=this.shield>0?'rgba(76,209,255,.9)':'rgba(255,74,110,.9)'; ctx.strokeStyle=ctx.shadowColor; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,this.radius*1.15,0,TAU); ctx.stroke(); }
    ctx.restore();
    // barra HP + apodo
    const barW=100, barH=10, pad=this.radius+22, ratio=this.hp/this.maxHP;
    ctx.save(); ctx.translate(this.x, this.y - pad);
    ctx.fillStyle='rgba(255,255,255,.15)'; ctx.fillRect(-barW/2, -barH/2, barW, barH);
    ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=2; ctx.strokeRect(-barW/2, -barH/2, barW, barH);
    ctx.fillStyle=isLocal? getComputedStyle(document.documentElement).getPropertyValue('--hp1') : getComputedStyle(document.documentElement).getPropertyValue('--hp2');
    ctx.fillRect(-barW/2, -barH/2, barW*ratio, barH);
    ctx.fillStyle='#e8efff'; ctx.font='bold 12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='bottom';
    ctx.fillText(this.name || (isLocal?'T√∫':'Rival'), 0, -8);
    ctx.restore();
  }
}

/* ====== Juego: estados ====== */
const players = new Map(); // id -> Blade
let localId = (Math.random().toString(36).slice(2)+Date.now().toString(36)).slice(0,12);
let localPlayer = null;
const game = {
  mode:'local', // 'local' | 'online'
  phase:'menu', // 'countdown' | 'window' | 'battle'
  countdownLeft:0, windowLeft:0, spawnTimer:0, cpuBoostTimer:3,
  angleById: new Map(), // id -> angle
  host:false,
  roomId:null,
  startTime:null,
  itemSeed: Math.floor(Math.random()*1e9)
};

/* ====== Dibujo arena / aim ====== */
function drawArena(){
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.translate(arena.cx,arena.cy);
  for(let i=6;i>=1;i--){
    const r=arena.r*(i/6);
    ctx.beginPath(); ctx.arc(0,0,r,0,TAU);
    const g=ctx.createRadialGradient(0,0,r*0.2,0,0,r);
    g.addColorStop(0,'#0c1120'); g.addColorStop(1,'#080b12');
    ctx.fillStyle=g; ctx.fill();
    ctx.strokeStyle = i%2 ? 'rgba(0,231,255,.30)' : 'rgba(138,43,255,.26)';
    ctx.lineWidth = i===6? 6 : 4;
    if(i===5) ctx.setLineDash([10,10]); else ctx.setLineDash([]);
    ctx.shadowColor = i%2? 'rgba(0,231,255,.45)' : 'rgba(138,43,255,.4)';
    ctx.shadowBlur=8; ctx.stroke(); ctx.shadowBlur=0;
  }
  ctx.beginPath(); ctx.arc(0,0,arena.innerR,0,TAU); ctx.setLineDash([8,10]);
  ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=2; ctx.stroke(); ctx.setLineDash([]); ctx.restore();
}
function drawAim(b,angle,col){ ctx.save(); ctx.strokeStyle=col; ctx.globalAlpha=.9; ctx.lineWidth=4; ctx.shadowColor=col; ctx.shadowBlur=10; ctx.beginPath(); ctx.moveTo(b.x,b.y); ctx.lineTo(b.x+Math.cos(angle)*160, b.y+Math.sin(angle)*160); ctx.stroke(); ctx.restore(); }

/* ====== Colisiones ====== */
function collide(a,b){
  if(!a.hasLaunched || !b.hasLaunched) return;
  const dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy), minD=a.radius+b.radius;
  if(d<=0||d>minD) return;
  const nx=dx/d, ny=dy/d, overlap=minD-d;
  a.x-=nx*overlap*0.5; a.y-=ny*overlap*0.5; b.x+=nx*overlap*0.5; b.y+=ny*overlap*0.5;
  const va=a.vx*nx+a.vy*ny, vb=b.vx*nx+b.vy*ny, m1=a.mass, m2=b.mass, k=0.9;
  const va2=(va*(m1-m2)+2*m2*vb)/(m1+m2), vb2=(vb*(m2-m1)+2*m1*va)/(m1+m2);
  a.vx+=(va2-va)*nx*k; a.vy+=(va2-va)*ny*k; b.vx+=(vb2-vb)*nx*k; b.vy+=(vb2-vb)*ny*k;
  const rel=Math.abs(va-vb), baseRPM=60+35*rel, baseHP=10+6*rel;
  let lossA=baseRPM, lossB=baseRPM;
  if(a.shield>0) lossA*=0.5; if(b.shield>0) lossB*=0.5;
  if(b.dmg>0) lossA*=1.4;    if(a.dmg>0) lossB*=1.4;
  a.spinRPM=Math.max(0,a.spinRPM-lossA); b.spinRPM=Math.max(0,b.spinRPM-lossB);
  let hpA=baseHP, hpB=baseHP; if(a.shield>0) hpA*=0.6; if(b.shield>0) hpB*=0.6; if(b.dmg>0) hpA*=1.3; if(a.dmg>0) hpB*=1.3;
  a.takeDamage(hpA); b.takeDamage(hpB);
  spawnSparks((a.x+b.x)/2,(a.y+b.y)/2, 22, Math.floor(Math.random()*360)); vibrate(12);
}

/* ====== Entradas (teclado / m√≥vil) ====== */
const keys=new Set();
addEventListener('keydown',e=>{
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','s','d','w','A','S','D','W',' ','r','R','Shift'].includes(e.key)) e.preventDefault();
  keys.add(e.key);
  if(e.key==='r'||e.key==='R') startLocalRound('cpu');
  if(localPlayer){
    if(game.phase==='window' && localPlayer.launching && (e.key===' ')) localFairLaunch();
    if(e.key==='w'||e.key==='W') tryLocalBoost(0,-1);
    if(e.key==='s'||e.key==='S') tryLocalBoost(0, 1);
    if(e.key==='a'||e.key==='A') tryLocalBoost(-1,0);
    if(e.key==='d'||e.key==='D') tryLocalBoost( 1,0);
  }
});
addEventListener('keyup',e=>{ keys.delete(e.key); });

/* M√≥vil */
function touch(btn, fn){ btn.addEventListener('touchstart', e=>{ e.preventDefault(); fn(); }, {passive:false}); }
touch(hud.btnU, ()=> tryLocalBoost(0,-1));
touch(hud.btnD, ()=> tryLocalBoost(0, 1));
touch(hud.btnL, ()=> tryLocalBoost(-1,0));
touch(hud.btnR, ()=> tryLocalBoost( 1,0));
touch(hud.btnP, ()=> { if(game.phase==='window' && localPlayer?.launching) localFairLaunch(); });

/* ====== UI de fases ====== */
function showMenu(show){ hud.menu.style.display= show ? 'block' : 'none'; }
function showOverlay(txt, sub){ hud.overlay.style.display='block'; hud.countBig.textContent=txt; hud.countSmall.textContent=sub||''; }
function hideOverlay(){ hud.overlay.style.display='none'; }
function showWin(name){ hud.winTitle.textContent = name? `${name} GANA` : '¬°FIN DE LA PARTIDA!'; hud.winSub.textContent='Volviendo al men√∫‚Ä¶'; hud.win.style.display='grid'; spawnConfettiBurst(W/2,H*0.25); setTimeout(()=>{ hud.win.style.display='none'; showMenu(true); game.mode==='online' && leaveRoom(); }, 2200); }

/* ====== Posicionamiento inicial seg√∫n N jugadores ====== */
function spawnPositions(n){
  const arr=[]; const r=arena.r*0.65;
  for(let i=0;i<n;i++){
    const a = -Math.PI/2 + i*TAU/n;
    arr.push({x: arena.cx + Math.cos(a)*r*0.75, y: arena.cy + Math.sin(a)*r*0.55, angle: a});
  }
  return arr;
}

/* ====== MODO LOCAL ====== */
function resetLocal(playersCount=2, withCPU=true){
  players.clear();
  const pos = spawnPositions(playersCount);
  for(let i=0;i<playersCount;i++){
    const id = i===0?'local':'cpu';
    const color = i===0? getComputedStyle(document.documentElement).getPropertyValue('--p1').trim() : getComputedStyle(document.documentElement).getPropertyValue('--p2').trim();
    const accent = i===0? '#7ad8ff' : '#ffb4b4';
    const b = new Blade({ id, name: i===0? NICK : (withCPU?'CPU':'P2'), color, accent });
    b.x=pos[i].x; b.y=pos[i].y; b.ensureSprite(); players.set(id,b);
    game.angleById.set(id, pos[i].angle);
  }
  localPlayer = players.get('local');
  hud.m1.style.width='100%'; hud.hp1.textContent='HP 100'; hud.boost1.textContent='Boost: listo';
  hud.m2.style.width='100%'; hud.hp2.textContent='-'; hud.boost2.textContent='';
  hud.modeLabel.textContent='LOCAL'; hud.roomInfo.textContent='';
  items.length=0; game.spawnTimer=1.5; game.cpuBoostTimer=3;
}
function startLocalRound(kind='cpu'){ game.mode='local'; setupArena(); resetLocal(kind==='cpu'?2:2, kind==='cpu'); showMenu(false); game.phase='countdown'; game.countdownLeft=3.0; game.windowLeft=0; showOverlay('3','prep√°rate‚Ä¶'); }
hud.btnP1.onclick=()=> startLocalRound('cpu');
hud.btn2P.onclick=()=> startLocalRound('2p');
hud.btnRestart.onclick=()=> (game.mode==='online' ? (roomStart(game.roomId)) : startLocalRound('cpu'));

/* ====== MODO ONLINE (Firebase) ====== */
let roomRef=null, meRef=null, evRef=null, itemsRef=null;
function joinRoom(){
  if(!db){ alert('Firebase no est√° configurado.'); return; }
  hud.modeLabel.textContent='ONLINE'; hud.roomInfo.textContent='conectando...';
  // Buscar/crear una sala con hueco (<10) y en lobby
  const roomsRoot = db.ref('rooms');
  roomsRoot.once('value', snap=>{
    const obj = snap.val()||{};
    let pickedId=null;
    for(const k of Object.keys(obj)){
      const r=obj[k];
      const count = r.players ? Object.keys(r.players).length : 0;
      if(r.state==='lobby' && count<10){ pickedId=k; break; }
    }
    if(!pickedId){ pickedId = Math.random().toString(36).slice(2,8); }
    game.roomId = pickedId;
    roomRef = roomsRoot.child(pickedId);
    // Unirme
    const now=Date.now();
    meRef = roomRef.child('players').child(localId);
    meRef.onDisconnect().remove();
    meRef.set({name:NICK, joinedAt:now, alive:true, hp:100, launch:false});
    // Host si soy el primero
    roomRef.child('players').once('value', s=>{
      const count=s.numChildren();
      game.host = count===1;
      if(game.host){
        roomRef.update({ state:'lobby', createdAt: now, seed: Math.floor(Math.random()*1e9) });
      }
      listenRoom();
    });
  });
}
function leaveRoom(){
  try{ meRef && meRef.remove(); }catch(e){}
  try{ roomRef && roomRef.child('state').off(); }catch(e){}
  try{ roomRef && roomRef.child('players').off(); }catch(e){}
  try{ roomRef && roomRef.child('events').off(); }catch(e){}
  try{ roomRef && roomRef.child('items').off(); }catch(e){}
  roomRef=meRef=evRef=itemsRef=null;
  game.roomId=null; game.host=false; game.phase='menu'; showMenu(true);
}
function listenRoom(){
  hud.roomInfo.textContent = `Sala ${game.roomId}`;
  // Jugadores
  roomRef.child('players').on('value', s=>{
    const obj=s.val()||{};
    const ids=Object.keys(obj);
    // si estamos en lobby y hay 2+, fijar inicio
    if(game.host && (!game.startTime)){
      if(ids.length>=2){
        const start = Date.now()+2500; // 2.5s
        roomRef.update({ state:'countdown', startTime:start });
      }
    }
  });
  // Estado
  roomRef.child('state').on('value', s=>{
    const st=s.val();
    if(!st) return;
    roomRef.child('startTime').once('value', stt=>{
      const t=stt.val();
      roomRef.child('seed').once('value', sd=>{
        const seed = sd.val()||Math.floor(Math.random()*1e9);
        if(st==='countdown' && t){
          roomStart(game.roomId, t, seed);
        }
      });
    });
  });
  // Eventos
  evRef = roomRef.child('events');
  evRef.on('child_added', snap=>{
    const ev = snap.val();
    if(!ev || !players.has(ev.uid)) return;
    const b = players.get(ev.uid);
    if(ev.type==='launch' && b.launching && game.phase==='window'){
      b.fairLaunch(game.angleById.get(b.id));
    }
    if(ev.type==='boost' && game.phase==='battle'){
      b.applyBoostDir(ev.dx, ev.dy);
    }
  });
  // Items del host
  itemsRef = roomRef.child('items');
  itemsRef.on('child_added', s=>{
    const it=s.val();
    if(it) spawnItemAt(it.x, it.y, it.type);
  });
}
function roomStart(roomId, startTime=null, seed=null){
  game.mode='online'; setupArena(); showMenu(false);
  // preparar jugadores actuales
  roomRef.child('players').once('value', s=>{
    players.clear();
    const obj=s.val()||{};
    const ids=Object.keys(obj).slice(0,10);
    const pos=spawnPositions(ids.length);
    ids.forEach((id,idx)=>{
      const color = id===localId? getComputedStyle(document.documentElement).getPropertyValue('--p1').trim() : getComputedStyle(document.documentElement).getPropertyValue('--p2').trim();
      const accent = id===localId? '#7ad8ff' : '#ffb4b4';
      const b=new Blade({id, name: obj[id].name||'Jugador', color, accent}); b.x=pos[idx].x; b.y=pos[idx].y; b.ensureSprite(); players.set(id,b); game.angleById.set(id, pos[idx].angle);
    });
    localPlayer = players.get(localId);
    items.length=0; game.spawnTimer=1.5; game.cpuBoostTimer=3;
    hud.modeLabel.textContent='ONLINE'; hud.roomInfo.textContent=`Sala ${game.roomId}`;
    // Si soy host, preprogramo algunos √≠tems en RTDB
    if(game.host){
      const hostItemsRef = roomRef.child('items');
      hostItemsRef.remove();
      for(let i=0;i<4;i++){ // 4 semillas de item al principio
        const a=rand(0,TAU), r=rand(arena.innerR*0.2, arena.innerR*0.85);
        const rec={x: arena.cx+Math.cos(a)*r, y: arena.cy+Math.sin(a)*r, type: randomItem()};
        hostItemsRef.push(rec);
      }
    }
    // Contador e inicio
    game.phase='countdown'; game.countdownLeft= startTime? Math.max(0,(startTime - Date.now())/1000) : 3.0; showOverlay(String(Math.ceil(game.countdownLeft)),'prep√°rate‚Ä¶');
    game.windowLeft=0;
    game.startTime=startTime||Date.now()+3000;
  });
}

/* ====== Entradas locales que se sincronizan si ONLINE ====== */
function sendEvent(ev){ if(game.mode==='online' && evRef){ evRef.push(Object.assign({uid:localId, ts:firebase.database.ServerValue.TIMESTAMP}, ev)); } }
function localFairLaunch(){ localPlayer.fairLaunch(game.angleById.get(localId)); sendEvent({type:'launch'}); }
function tryLocalBoost(dx,dy){ if(!localPlayer) return; if(localPlayer.applyBoostDir(dx,dy)){ sendEvent({type:'boost', dx, dy}); } }

/* ====== LOOP ====== */
function drawAll(dt){
  drawArena();

  // estado de fases (local u online)
  if(game.phase==='countdown'){
    // permitir ajustar √°ngulo de cada jugador SOLO local (para online simplificamos al jugador local)
    if(localPlayer){
      if(keys.has('a')||keys.has('A')||keys.has('ArrowLeft')) game.angleById.set(localId, (game.angleById.get(localId) || -Math.PI/3) - 0.05);
      if(keys.has('d')||keys.has('D')||keys.has('ArrowRight')) game.angleById.set(localId, (game.angleById.get(localId) || -Math.PI/3) + 0.05);
    }
    game.countdownLeft-=dt;
    const whole=Math.ceil(game.countdownLeft);
    if(game.countdownLeft>0){ showOverlay(String(whole),'prep√°rate‚Ä¶'); }
    else{ game.phase='window'; game.windowLeft=2.0; showOverlay('GO!','tienes 2.0s para lanzar'); }
  }
  else if(game.phase==='window'){
    game.windowLeft-=dt; hud.countSmall.textContent=`tienes ${Math.max(0,game.windowLeft).toFixed(1)}s para lanzar`;
    if(game.windowLeft<=0){
      // quien no lanz√≥ pierde
      for(const b of players.values()){ if(!b.hasLaunched) b.alive=false; b.launching=false; }
      hideOverlay(); game.phase='battle';
    }
  }
  else if(game.phase==='battle'){
    // Items de aparici√≥n local peri√≥dica (en online, ya se agregaron al empezar; puedes a√±adir m√°s cada cierto tiempo si eres host)
    game.spawnTimer-=dt; if(game.spawnTimer<=0){
      if(game.mode==='local' || game.host){
        const a=rand(0,TAU), r=rand(arena.innerR*0.2, arena.innerR*0.85), type=randomItem();
        const rec={x: arena.cx+Math.cos(a)*r, y: arena.cy+Math.sin(a)*r, type};
        if(game.mode==='online') roomRef.child('items').push(rec); else spawnItemAt(rec.x,rec.y,rec.type);
      }
      game.spawnTimer=rand(6,9);
    }
    // F√≠sica + colisiones de todos
    const arr=[...players.values()];
    arr.forEach(b=>b.step(dt));
    for(let i=0;i<arr.length;i++) for(let j=i+1;j<arr.length;j++) collide(arr[i],arr[j]);

    // recogida de items
    arr.forEach(b=>tryPickup(b));

    // fin de partida cuando queda solo 1 vivo (o 0)
    const vivos = arr.filter(b=>b.alive);
    if(vivos.length<=1){
      game.phase='menu';
      const ganador = vivos[0]?.name || 'Nadie';
      showWin(ganador);
    }
  }

  // Aims para los que no lanzaron
  for(const [id,b] of players){
    const ang=game.angleById.get(id)||(-Math.PI/3);
    if(b.launching && (game.phase==='countdown'||game.phase==='window')) drawAim(b,ang, id===localId? '#33d6ff' : '#ff6b6b');
  }

  // Dibujo jugadores + UI superior (solo muestra local en badges)
  let lp = localPlayer || [...players.values()][0];
  if(lp){
    hud.m1.style.width=(lp.hp/lp.maxHP*100).toFixed(0)+'%';
    hud.hp1.textContent='HP '+Math.max(0,Math.round(lp.hp));
    hud.boost1.textContent = lp.boostCD>0 ? `Boost: ${lp.boostCD.toFixed(2)}s` : 'Boost: listo';
    document.getElementById('p1Name').textContent = lp.name || NICK;
  }
  // Dibujar todos (local resaltado)
  for(const [id,b] of players){ b.draw(id===localId); }

  // Part√≠culas
  drawItems(dt); drawSparks(dt); stepToast(dt); drawConfetti(dt);
}

let last=0;
function loop(t){ const dt=Math.min(0.033,(t-last||16)/1000); last=t; drawAll(dt); requestAnimationFrame(loop); }
requestAnimationFrame(loop);

/* ====== BOT√ìN ONLINE ====== */
hud.btnON.onclick=()=>{ showMenu(false); joinRoom(); };

/* ====== INIT ====== */
setupArena();
resetLocal(2,true);
showMenu(true);

})();
</script>
</body>
</html>
